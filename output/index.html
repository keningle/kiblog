<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title> KenIngle.com</title>

    <link rel="stylesheet" href="/theme/css/main.css">
    <link rel="stylesheet" href="/theme/css/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1><a href="/">KenIngle.com </a></h1>
        <p></p>


        <p class="view"></p>

      </header>
      <section>
      	            

                            <aside id="featured" class="body">
                <article>
                    <span class="octicon octicon-link"><a href="/passing-url-parameters-to-a-decorator-in-django.html">Passing URL Parameters to a Decorator in Django</a></span> 
                    <footer class="post-info">
        <abbr class="published" title="2013-07-03T11:57:00">
                Wed 03 July 2013
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="/author/ken-ingle.html">Ken Ingle</a>
        </address>
        <p>In <a href="/category/blog.html">Blog</a>. </p>
<p>tags: <a href="/tag/django.html">django</a><a href="/tag/python.html">python</a></p>
</footer><!-- /.post-info --><h1>Passing URL Parameters to a Decorator in Django</h1>
<p>I have been working on a small project where I needed to pass a URL parameter to a decorator I was writing.  In an ongoing effort to follow the principal of DRY, I have found that decorators (when used at the right time) can really help.  I was able to find no shortage of examples where decorators made life easier in django applications (e.g. login_required).</p>
<p>After a bit of searching and asking around I came across a really great blog post by Charles Leifer describing in details how to accomplish almost exactly what I needed.</p>
<p>For the purposes of this example, let’s assume I have a Company model where I have defined a company_admin foreign key that relates to a user object as the admin for the company (in practice I would recommend using the groups and permissions already built into django, but this is just an example).</p>
<p>Let’s say I have a URL pattern that looks something like this:</p>
<div class="highlight"><pre><span class="n">url</span><span class="p">(</span><span class="s">r&#39;^example/(?P&lt;slug&gt;[a-z0-9-]+)/$&#39;</span><span class="p">,</span> <span class="s">&#39;some.view&#39;</span><span class="p">),</span>
</pre></div>


<p>Initially my view (and probably many views) might have been checking to see if this logged-in user was an admin kind of like this:</p>
<div class="highlight"><pre><span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">some_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">slug</span><span class="p">):</span>
    <span class="c"># Get the company object based on slug</span>
    <span class="n">company</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Company</span><span class="p">,</span> <span class="n">slug</span><span class="o">=</span><span class="n">slug</span><span class="p">)</span>

    <span class="c"># Check and see if the logged in user is admin</span>
    <span class="k">if</span> <span class="n">company</span><span class="o">.</span><span class="n">admin_user</span> <span class="o">!=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">()</span>

    <span class="o">....</span> <span class="n">view</span> <span class="n">logic</span> <span class="o">....</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;company/index.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;company&#39;</span><span class="p">:</span> <span class="n">company</span><span class="p">})</span>
</pre></div>


<p>I want to create a decorator that will wrap the view, take the slug and handle the verification that this user should have access to this company.  I will then want to return to the view the actual company object instead of the slug.  </p>
<p>This will give me the capability to re-use the authentication as well as have my company object (which is useful) instead of simply the slug:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.utils.functional</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="o">...</span>

<span class="k">def</span> <span class="nf">check_company_admin</span><span class="p">(</span><span class="n">view</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">slug</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># Get the company object</span>
        <span class="n">company</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Company</span><span class="p">,</span> <span class="n">slug</span><span class="o">=</span><span class="n">slug</span><span class="p">)</span>

        <span class="c"># Check and see if the logged in user is admin</span>
        <span class="k">if</span> <span class="n">company</span><span class="o">.</span><span class="n">admin_user</span> <span class="o">!=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">()</span>

        <span class="c"># Return the actual company object to the view</span>
        <span class="k">return</span> <span class="n">view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">company</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">inner</span>
</pre></div>


<p>Finally, my view will change to use the decorator and remove the duplicate logic:</p>
<div class="highlight"><pre><span class="nd">@login_required</span>
<span class="nd">@check_company_admin</span>
<span class="k">def</span> <span class="nf">some_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">company</span><span class="p">):</span>
    <span class="c"># Even though the slug is in the URL. We are getting a company </span>
    <span class="c"># object back from the decorator</span>

    <span class="o">....</span> <span class="n">view</span> <span class="n">logic</span> <span class="o">....</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;company/index.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;company&#39;</span><span class="p">:</span> <span class="n">company</span><span class="p">})</span>
</pre></div>


<p>This creates a re-usable decorator that utilizes URL parameters.  I hope this helps more people than just me.  Feel free to comment if there is a better way to do this or if I should change something.</p>                </article>
                            </aside><!-- /#featured -->
                            <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                    <ol id="posts-list" class="hfeed">
                                                

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="/hello-world.html" rel="bookmark"
                           title="Permalink to Hello World!">Hello World!</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2013-07-03T10:57:00">
                Wed 03 July 2013
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="/author/ken-ingle.html">Ken Ingle</a>
        </address>
        <p>In <a href="/category/python.html">Python</a>. </p>
<p>tags: <a href="/tag/pelican.html">pelican</a><a href="/tag/publishing.html">publishing</a></p>
</footer><!-- /.post-info -->                <p>This is the first post</p>
                <a class="readmore" href="/hello-world.html">read more</a>
                                </div><!-- /.entry-content -->
            </article></li>
                            </ol><!-- /#posts-list -->
                            <p class="paginator">
        Page 1 / 1
    </p>
                        </section><!-- /#content -->
                  </section>
      <footer>
        <p><small>&copy; Ken Ingle 2013, &mdash; Theme based on Sundown by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <!-- Scale fix -->
    <script>
      var metas = document.getElementsByTagName('meta');
      var i;
      
      if (navigator.userAgent.match(/iPhone/i)) {
        for (i=0; i<metas.length; i++) {
          if (metas[i].name == "viewport") {
            metas[i].content = "width=device-width, minimum-scale=1.0, maximum-scale=1.0";
          }
        }
      
        document.addEventListener("gesturestart", gestureStart, false);
      }

      function gestureStart() {
        for (i=0; i<metas.length; i++) {
          if (metas[i].name == "viewport") {
            metas[i].content = "width=device-width, minimum-scale=0.25, maximum-scale=1.6";
          }
        }
      }
    </script>
  </body>
</html>